import{d as P,u as T,r as u,F,c as M,b as l,w as i,e as s,z as b,N as j,R as V,H as y,m as C,B as p,k as x,K as $,v as o,L as E,g as O,h as c,i as k,S as R,T as A,Q as H,U as D,o as K}from"./index-BZbewaeb.js";const Q={style:{"margin-top":"16px",display:"flex","justify-content":"flex-end"}},J=P({__name:"Licenses",setup(q){const r=T(),f=u(!1),w=u([]),m=u(1),g=u(20),N=u(0),v=u(!1),_=u(!1),n=u({user_id:null,plan_type:"yearly",expire_date:null,max_users:5,notes:""}),z=[{label:"月度版",value:"monthly"},{label:"年度版",value:"yearly"},{label:"终身版",value:"lifetime"},{label:"试用版（7天）",value:"trial"},{label:"限免版",value:"promo_free"},{label:"永久免费",value:"free_forever"}],U={pending:{label:"待激活",type:"warning"},active:{label:"已激活",type:"success"},expired:{label:"已过期",type:"error"},revoked:{label:"已吊销",type:"error"}},h=[{title:"ID",key:"id",width:60},{title:"授权码",key:"license_key",width:200,ellipsis:{tooltip:!0},render:a=>o("code",{style:"font-size: 12px"},a.license_key)},{title:"客户",key:"user",width:150,render:a=>{var e,t;return((e=a.user)==null?void 0:e.company_name)||((t=a.user)==null?void 0:t.username)||`用户#${a.user_id}`}},{title:"版本",key:"plan_type",width:90,render:a=>{const e=z.find(t=>t.value===a.plan_type);return(e==null?void 0:e.label)||a.plan_type}},{title:"状态",key:"status",width:90,render:a=>{const e=U[a.status]||{label:a.status,type:"info"};return o(H,{type:e.type,size:"small"},()=>e.label)}},{title:"到期时间",key:"expire_date",width:110,render:a=>a.expire_date?new Date(a.expire_date).toLocaleDateString("zh-CN"):"永久"},{title:"机器码",key:"machine_id",width:100,ellipsis:{tooltip:!0},render:a=>a.machine_id||"-"},{title:"操作",key:"actions",width:200,render:a=>o(b,{size:"small"},()=>[a.status==="active"&&o(D,{onPositiveClick:()=>L(a.id)},{trigger:()=>o(p,{size:"small",type:"error"},()=>"吊销"),default:()=>"确定吊销此授权？"}),a.machine_id&&o(D,{onPositiveClick:()=>S(a.id)},{trigger:()=>o(p,{size:"small"},()=>"解绑"),default:()=>"确定解除机器绑定？"}),o(p,{size:"small",onClick:()=>B(a.id)},()=>"续期")])}],d=async()=>{f.value=!0;try{const a=await y.getLicenses({page:m.value,page_size:g.value});a.code===200&&(w.value=a.data.items,N.value=a.data.total)}catch{r.error("加载失败")}finally{f.value=!1}},I=async()=>{if(!n.value.user_id){r.warning("请输入客户ID");return}_.value=!0;try{const a={user_id:n.value.user_id,plan_type:n.value.plan_type,max_users:n.value.max_users,notes:n.value.notes||void 0};n.value.expire_date&&(a.expire_date=new Date(n.value.expire_date).toISOString().split("T")[0]);const e=await y.createLicense(a);e.code===200?(r.success("创建成功"),v.value=!1,n.value={user_id:null,plan_type:"yearly",expire_date:null,max_users:5,notes:""},d()):r.error(e.message||"创建失败")}catch(a){r.error(a.message||"创建失败")}finally{_.value=!1}},L=async a=>{try{(await y.revokeLicense(a,"管理员手动吊销")).code===200&&(r.success("已吊销"),d())}catch{r.error("操作失败")}},S=async a=>{try{(await y.unbindLicense(a)).code===200&&(r.success("已解绑"),d())}catch{r.error("操作失败")}},B=async a=>{const e=window.prompt("请输入续期天数","365");if(e)try{(await y.extendLicense(a,parseInt(e))).code===200&&(r.success("续期成功"),d())}catch{r.error("操作失败")}};return F(d),(a,e)=>(K(),M("div",null,[l(s(b),{justify:"space-between",align:"center",style:{"margin-bottom":"24px"}},{default:i(()=>[e[11]||(e[11]=C("h2",{style:{margin:"0"}},"授权管理",-1)),l(s(p),{type:"primary",onClick:e[0]||(e[0]=t=>v.value=!0)},{default:i(()=>[...e[10]||(e[10]=[x("新建授权",-1)])]),_:1})]),_:1}),l(s(j),null,{default:i(()=>[l(s($),{columns:h,data:w.value,loading:f.value,bordered:!1},null,8,["data","loading"]),C("div",Q,[l(s(E),{page:m.value,"onUpdate:page":[e[1]||(e[1]=t=>m.value=t),d],"page-size":g.value,"onUpdate:pageSize":[e[2]||(e[2]=t=>g.value=t),d],"item-count":N.value,"page-sizes":[20,50,100],"show-size-picker":""},null,8,["page","page-size","item-count"])])]),_:1}),l(s(V),{show:v.value,"onUpdate:show":e[9]||(e[9]=t=>v.value=t),title:"新建授权",preset:"card",style:{width:"500px"}},{footer:i(()=>[l(s(b),{justify:"end"},{default:i(()=>[l(s(p),{onClick:e[8]||(e[8]=t=>v.value=!1)},{default:i(()=>[...e[12]||(e[12]=[x("取消",-1)])]),_:1}),l(s(p),{type:"primary",loading:_.value,onClick:I},{default:i(()=>[...e[13]||(e[13]=[x("创建",-1)])]),_:1},8,["loading"])]),_:1})]),default:i(()=>[l(s(O),{"label-placement":"left","label-width":"80"},{default:i(()=>[l(s(c),{label:"客户ID"},{default:i(()=>[l(s(k),{value:n.value.user_id,"onUpdate:value":e[3]||(e[3]=t=>n.value.user_id=t),type:"number",placeholder:"输入客户ID"},null,8,["value"])]),_:1}),l(s(c),{label:"版本类型"},{default:i(()=>[l(s(R),{value:n.value.plan_type,"onUpdate:value":e[4]||(e[4]=t=>n.value.plan_type=t),options:z},null,8,["value"])]),_:1}),l(s(c),{label:"到期日期"},{default:i(()=>[l(s(A),{value:n.value.expire_date,"onUpdate:value":e[5]||(e[5]=t=>n.value.expire_date=t),type:"date",clearable:"",style:{width:"100%"}},null,8,["value"])]),_:1}),l(s(c),{label:"用户数"},{default:i(()=>[l(s(k),{value:n.value.max_users,"onUpdate:value":e[6]||(e[6]=t=>n.value.max_users=t),type:"number"},null,8,["value"])]),_:1}),l(s(c),{label:"备注"},{default:i(()=>[l(s(k),{value:n.value.notes,"onUpdate:value":e[7]||(e[7]=t=>n.value.notes=t),type:"textarea"},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["show"])]))}});export{J as default};
