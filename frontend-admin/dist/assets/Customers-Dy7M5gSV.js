import{d as A,u as H,r as u,F as K,c as B,b as s,w as o,e as t,z as x,N as O,K as Q,H as w,l as k,B as y,k as z,L as G,v as _,M as J,O as D,g as W,q as X,h as r,i as p,P as Y,C as F,f as Z,Q as ee,o as U}from"./index-g5hkaJ8F.js";const ae={style:{"margin-top":"16px",display:"flex","justify-content":"flex-end"}},le={key:0,style:{"margin-top":"12px",padding:"10px 12px",background:"#fffbe6",border:"1px solid #ffe58f","border-radius":"6px"}},te={style:{"font-family":"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace"}},oe=A({__name:"Customers",setup(se){const I=Z(),i=H(),C=u(!1),g=u(!1),N=u([]),M=u(0),d=u(1),h=u(20),v=u(!1),c=u(!1),b=u(null),m=u(null),S=u(null),a=u({username:"",email:"",password:"",company_name:"",contact_name:"",phone:"",address:"",is_active:!0}),R=[{title:"ID",key:"id",width:60},{title:"用户名",key:"username",width:120},{title:"企业名称",key:"company_name",ellipsis:{tooltip:!0}},{title:"联系人",key:"contact_name",width:100},{title:"邮箱",key:"email",width:180},{title:"电话",key:"phone",width:130},{title:"注册时间",key:"created_at",width:160,render:n=>n.created_at?new Date(n.created_at).toLocaleString("zh-CN"):"-"},{title:"操作",key:"actions",width:220,render:n=>_(x,{size:8},()=>[_(y,{size:"small",onClick:()=>I.push(`/customers/${n.id}`)},()=>"详情"),_(y,{size:"small",type:"primary",onClick:()=>q(n.id)},()=>"编辑"),_(ee,{onPositiveClick:()=>L(n.id)},{trigger:()=>_(y,{size:"small",type:"error"},()=>"删除"),default:()=>"确认删除该客户？（会同时删除其授权/订单记录）"})])}],f=async()=>{C.value=!0;try{const n=await w.getCustomers({page:d.value,page_size:h.value});n.code===200&&(N.value=n.data.items,M.value=n.data.total||0)}catch{i.error("加载失败")}finally{C.value=!1}},V=()=>{m.value=null,a.value={username:"",email:"",password:"",company_name:"",contact_name:"",phone:"",address:"",is_active:!0}},j=()=>{c.value=!1,b.value=null,V(),v.value=!0},q=async n=>{c.value=!0,b.value=n,m.value=null,v.value=!0,g.value=!0;try{const e=await w.getCustomer(n);e.code===200?(a.value.username=e.data.username||"",a.value.email=e.data.email||"",a.value.password="",a.value.company_name=e.data.company_name||"",a.value.contact_name=e.data.contact_name||"",a.value.phone=e.data.phone||"",a.value.address=e.data.address||"",a.value.is_active=!!e.data.is_active):i.error(e.message||"加载详情失败")}catch{i.error("加载详情失败")}finally{g.value=!1}},E=async()=>{var n,e;await((n=S.value)==null?void 0:n.validate()),g.value=!0,m.value=null;try{if(c.value&&b.value){const P=await w.updateCustomer(b.value,{username:a.value.username,email:a.value.email,company_name:a.value.company_name||void 0,contact_name:a.value.contact_name||void 0,phone:a.value.phone||void 0,address:a.value.address||void 0,is_active:a.value.is_active});P.code===200?(i.success("更新成功"),v.value=!1,await f()):i.error(P.message||"更新失败");return}const l=await w.createCustomer({username:a.value.username,email:a.value.email,password:a.value.password||void 0,company_name:a.value.company_name||void 0,contact_name:a.value.contact_name||void 0,phone:a.value.phone||void 0,address:a.value.address||void 0,is_active:a.value.is_active});l.code===200?(i.success("创建成功"),m.value=((e=l.data)==null?void 0:e.initial_password)||null,await f(),m.value||(v.value=!1)):i.error(l.message||"创建失败")}catch{i.error("操作失败")}finally{g.value=!1}},L=async n=>{try{const e=await w.deleteCustomer(n);e.code===200?(i.success("删除成功"),N.value.length===1&&d.value>1&&(d.value-=1),await f()):i.error(e.message||"删除失败")}catch{i.error("删除失败")}},T=async n=>{d.value=n,await f()},$=async n=>{h.value=n,d.value=1,await f()};return K(f),(n,e)=>(U(),B("div",null,[s(t(x),{align:"center",justify:"space-between",style:{"margin-bottom":"24px"}},{default:o(()=>[e[13]||(e[13]=k("h2",{style:{margin:"0"}},"客户管理",-1)),s(t(y),{type:"primary",onClick:j},{default:o(()=>[...e[12]||(e[12]=[z("新建客户",-1)])]),_:1})]),_:1}),s(t(O),null,{default:o(()=>[s(t(G),{columns:R,data:N.value,loading:C.value,bordered:!1},null,8,["data","loading"]),k("div",ae,[s(t(J),{page:d.value,"onUpdate:page":[e[0]||(e[0]=l=>d.value=l),T],"page-size":h.value,"onUpdate:pageSize":[e[1]||(e[1]=l=>h.value=l),$],"item-count":M.value,"page-sizes":[20,50,100],"show-size-picker":""},null,8,["page","page-size","item-count"])])]),_:1}),s(t(Q),{show:v.value,"onUpdate:show":e[11]||(e[11]=l=>v.value=l),preset:"card",style:{width:"560px"},title:c.value?"编辑客户":"新建客户"},{footer:o(()=>[s(t(x),{justify:"end"},{default:o(()=>[s(t(y),{onClick:e[10]||(e[10]=l=>v.value=!1)},{default:o(()=>[...e[15]||(e[15]=[z("取消",-1)])]),_:1}),s(t(y),{type:"primary",loading:g.value,onClick:E},{default:o(()=>[z(F(c.value?"保存":"创建"),1)]),_:1},8,["loading"])]),_:1})]),default:o(()=>[s(t(W),{ref_key:"formRef",ref:S,model:a.value,"label-placement":"left","label-width":"90"},{default:o(()=>[s(t(r),{label:"用户名",path:"username",rule:{required:!0,message:"请输入用户名",trigger:["blur","input"]}},{default:o(()=>[s(t(p),{value:a.value.username,"onUpdate:value":e[2]||(e[2]=l=>a.value.username=l),placeholder:"请输入用户名"},null,8,["value"])]),_:1}),s(t(r),{label:"邮箱",path:"email",rule:{required:!0,message:"请输入邮箱",trigger:["blur","input"]}},{default:o(()=>[s(t(p),{value:a.value.email,"onUpdate:value":e[3]||(e[3]=l=>a.value.email=l),placeholder:"请输入邮箱"},null,8,["value"])]),_:1}),c.value?D("",!0):(U(),X(t(r),{key:0,label:"初始密码",path:"password"},{default:o(()=>[s(t(p),{value:a.value.password,"onUpdate:value":e[4]||(e[4]=l=>a.value.password=l),placeholder:"不填则自动生成"},null,8,["value"])]),_:1})),s(t(r),{label:"企业名称",path:"company_name"},{default:o(()=>[s(t(p),{value:a.value.company_name,"onUpdate:value":e[5]||(e[5]=l=>a.value.company_name=l),placeholder:"可选"},null,8,["value"])]),_:1}),s(t(r),{label:"联系人",path:"contact_name"},{default:o(()=>[s(t(p),{value:a.value.contact_name,"onUpdate:value":e[6]||(e[6]=l=>a.value.contact_name=l),placeholder:"可选"},null,8,["value"])]),_:1}),s(t(r),{label:"电话",path:"phone"},{default:o(()=>[s(t(p),{value:a.value.phone,"onUpdate:value":e[7]||(e[7]=l=>a.value.phone=l),placeholder:"可选"},null,8,["value"])]),_:1}),s(t(r),{label:"地址",path:"address"},{default:o(()=>[s(t(p),{value:a.value.address,"onUpdate:value":e[8]||(e[8]=l=>a.value.address=l),placeholder:"可选"},null,8,["value"])]),_:1}),s(t(r),{label:"启用",path:"is_active"},{default:o(()=>[s(t(Y),{value:a.value.is_active,"onUpdate:value":e[9]||(e[9]=l=>a.value.is_active=l)},null,8,["value"])]),_:1})]),_:1},8,["model"]),m.value?(U(),B("div",le,[e[14]||(e[14]=k("div",{style:{"font-weight":"600","margin-bottom":"6px"}},"系统已自动生成初始密码（请及时复制保存）：",-1)),k("div",te,F(m.value),1)])):D("",!0)]),_:1},8,["show","title"])]))}});export{oe as default};
