import{d as P,u as q,X as F,r,F as A,c as M,b as s,w as n,e as l,z,N as E,Y as K,K as W,W as C,l as D,U as X,L as Y,v,M as Z,B as g,k as u,q as I,O as G,R as i,C as d,T as L,Z as H,S as J,i as Q,o as b}from"./index-g5hkaJ8F.js";const ee={style:{"margin-top":"16px",display:"flex","justify-content":"flex-end"}},ae={key:1},te={style:{"white-space":"pre-wrap",margin:"0"}},ne=P({__name:"Orders",setup(le){const p=q(),S=F(),k=r(!1),T=r([]),w=r(1),N=r(20),$=r(0),_=r(null),h=r(!1),t=r(null),y=r(""),U={monthly:"月度版",yearly:"年度版",lifetime:"终身版",trial:"试用版"},x={pending:{label:"待审核",type:"warning"},paid:{label:"已完成",type:"success"},cancelled:{label:"已取消",type:"error"},refunded:{label:"已退款",type:"info"}},O=[{label:"全部",value:null},{label:"待审核",value:"pending"},{label:"已完成",value:"paid"},{label:"已取消",value:"cancelled"}],R=[{title:"订单号",key:"order_no",width:180},{title:"客户",key:"user",width:150,render:a=>{var e,m;return((e=a.user)==null?void 0:e.company_name)||((m=a.user)==null?void 0:m.username)||`用户#${a.user_id}`}},{title:"套餐",key:"plan_type",width:90,render:a=>U[a.plan_type]||a.plan_type},{title:"金额",key:"amount",width:90,render:a=>a.amount>0?`¥${a.amount}`:"免费"},{title:"状态",key:"status",width:90,render:a=>{const e=x[a.status]||{label:a.status,type:"info"};return v(L,{type:e.type,size:"small"},()=>e.label)}},{title:"支付凭证",key:"payment_proof",width:90,render:a=>a.payment_proof?"已上传":"-"},{title:"创建时间",key:"created_at",width:160,render:a=>new Date(a.created_at).toLocaleString("zh-CN")},{title:"操作",key:"actions",width:150,render:a=>v(z,{size:"small"},()=>[v(g,{size:"small",onClick:()=>V(a)},()=>"详情"),a.status==="pending"&&v(g,{size:"small",type:"primary",onClick:()=>j(a)},()=>"通过"),a.status==="pending"&&v(g,{size:"small",type:"error",onClick:()=>B(a)},()=>"拒绝")])}],c=async()=>{k.value=!0;try{const a={page:w.value,page_size:N.value};_.value&&(a.status=_.value);const e=await C.get("/orders/admin/list",a);e.code===200&&(T.value=e.data.items,$.value=e.data.total)}catch{p.error("加载失败")}finally{k.value=!1}},V=a=>{t.value=a,h.value=!0},j=a=>{S.warning({title:"确认审核通过",content:`确定通过订单 ${a.order_no} 吗？通过后将自动生成授权码。`,positiveText:"确认通过",negativeText:"取消",onPositiveClick:async()=>{try{const e=await C.post(`/orders/admin/${a.id}/approve`);e.code===200?(p.success("审核通过，授权码已生成"),c()):p.error(e.message||"操作失败")}catch{p.error("操作失败")}}})},B=a=>{t.value=a,y.value="",S.warning({title:"拒绝订单",content:()=>v("div",[v("p","请输入拒绝原因："),v(Q,{value:y.value,"onUpdate:value":e=>{y.value=e},type:"textarea",rows:3})]),positiveText:"确认拒绝",negativeText:"取消",onPositiveClick:async()=>{if(!y.value.trim())return p.warning("请输入拒绝原因"),!1;try{const e=await C.post(`/orders/admin/${a.id}/reject?reason=${encodeURIComponent(y.value)}`);e.code===200?(p.success("已拒绝"),c()):p.error(e.message||"操作失败")}catch{p.error("操作失败")}}})};return A(c),(a,e)=>{var m;return b(),M("div",null,[s(l(z),{justify:"space-between",align:"center",style:{"margin-bottom":"24px"}},{default:n(()=>[e[6]||(e[6]=D("h2",{style:{margin:"0"}},"订单审核",-1)),s(l(X),{value:_.value,"onUpdate:value":[e[0]||(e[0]=o=>_.value=o),c],options:O,style:{width:"150px"},placeholder:"筛选状态"},null,8,["value"])]),_:1}),s(l(E),null,{default:n(()=>[s(l(Y),{columns:R,data:T.value,loading:k.value,bordered:!1},null,8,["data","loading"]),D("div",ee,[s(l(Z),{page:w.value,"onUpdate:page":[e[1]||(e[1]=o=>w.value=o),c],"page-size":N.value,"onUpdate:pageSize":[e[2]||(e[2]=o=>N.value=o),c],"item-count":$.value,"page-sizes":[20,50,100],"show-size-picker":""},null,8,["page","page-size","item-count"])])]),_:1}),s(l(W),{show:h.value,"onUpdate:show":e[5]||(e[5]=o=>h.value=o),title:"订单详情",preset:"card",style:{width:"600px"}},K({default:n(()=>[t.value?(b(),I(l(J),{key:0,column:2,"label-placement":"left"},{default:n(()=>[s(l(i),{label:"订单号"},{default:n(()=>[u(d(t.value.order_no),1)]),_:1}),s(l(i),{label:"状态"},{default:n(()=>{var o;return[s(l(L),{type:((o=x[t.value.status])==null?void 0:o.type)||"default"},{default:n(()=>{var f;return[u(d(((f=x[t.value.status])==null?void 0:f.label)||t.value.status),1)]}),_:1},8,["type"])]}),_:1}),s(l(i),{label:"客户"},{default:n(()=>{var o,f;return[u(d(((o=t.value.user)==null?void 0:o.company_name)||((f=t.value.user)==null?void 0:f.username)),1)]}),_:1}),s(l(i),{label:"套餐"},{default:n(()=>[u(d(U[t.value.plan_type]||t.value.plan_type),1)]),_:1}),s(l(i),{label:"金额"},{default:n(()=>[u(d(t.value.amount>0?`¥${t.value.amount}`:"免费"),1)]),_:1}),s(l(i),{label:"促销码"},{default:n(()=>[u(d(t.value.promo_code||"-"),1)]),_:1}),s(l(i),{label:"创建时间"},{default:n(()=>[u(d(new Date(t.value.created_at).toLocaleString("zh-CN")),1)]),_:1}),s(l(i),{label:"完成时间"},{default:n(()=>[u(d(t.value.paid_at?new Date(t.value.paid_at).toLocaleString("zh-CN"):"-"),1)]),_:1}),s(l(i),{label:"支付凭证",span:2},{default:n(()=>[t.value.payment_proof?(b(),I(l(H),{key:0,src:t.value.payment_proof,width:"200",style:{"max-height":"300px"}},null,8,["src"])):(b(),M("span",ae,"未上传"))]),_:1}),s(l(i),{label:"备注",span:2},{default:n(()=>[D("pre",te,d(t.value.notes||"-"),1)]),_:1})]),_:1})):G("",!0)]),_:2},[((m=t.value)==null?void 0:m.status)==="pending"?{name:"footer",fn:n(()=>[s(l(z),{justify:"end"},{default:n(()=>[s(l(g),{type:"error",onClick:e[3]||(e[3]=o=>B(t.value))},{default:n(()=>[...e[7]||(e[7]=[u("拒绝",-1)])]),_:1}),s(l(g),{type:"primary",onClick:e[4]||(e[4]=o=>j(t.value))},{default:n(()=>[...e[8]||(e[8]=[u("通过",-1)])]),_:1})]),_:1})]),key:"0"}:void 0]),1032,["show"])])}}});export{ne as default};
