import{d as W,u as G,a as J,r as i,n as X,F as Y,c as Z,b as t,w as u,e as s,z as _,N as ee,K as q,H as k,l as B,B as v,k as b,L as ae,v as d,M as le,g as D,q as se,O as te,h as g,i as h,P as re,C as ue,T as M,Q as ie,o as I}from"./index-g5hkaJ8F.js";const ne={style:{"margin-top":"16px",display:"flex","justify-content":"flex-end"}},ve=W({__name:"Admins",setup(oe){const n=G(),T=J(),N=i(!1),f=i(!1),U=i([]),x=i(0),p=i(1),C=i(20),m=i(!1),c=i(!1),z=i(null),P=i(null),r=i({username:"",email:"",password:"",is_active:!0}),y=i(!1),S=i(null),A=i(null),o=i({new_password:"",confirm_password:""}),F=X(()=>{var a;return((a=T.user)==null?void 0:a.id)||0}),j=[{title:"ID",key:"id",width:70},{title:"用户名",key:"username",width:160,render:a=>d(_,{size:8,align:"center"},()=>[d("span",a.username),a.id===F.value?d(M,{size:"small",type:"info"},()=>"当前"):null])},{title:"邮箱",key:"email",minWidth:220,ellipsis:{tooltip:!0}},{title:"状态",key:"is_active",width:90,render:a=>d(M,{size:"small",type:a.is_active?"success":"error"},()=>a.is_active?"启用":"禁用")},{title:"创建时间",key:"created_at",width:170,render:a=>a.created_at?new Date(a.created_at).toLocaleString("zh-CN"):"-"},{title:"操作",key:"actions",width:280,render:a=>d(_,{size:8},()=>[d(v,{size:"small",type:"primary",onClick:()=>E(a)},()=>"编辑"),d(v,{size:"small",onClick:()=>O(a)},()=>"改密"),d(ie,{onPositiveClick:()=>$(a)},{trigger:()=>d(v,{size:"small",type:"error",disabled:a.id===F.value},()=>"删除"),default:()=>"确认删除该管理员？"})])}],w=async()=>{N.value=!0;try{const a=await k.getAdmins({page:p.value,page_size:C.value});a.code===200?(U.value=a.data.items||[],x.value=a.data.total||0):n.error(a.message||"加载失败")}catch{n.error("加载失败")}finally{N.value=!1}},R=()=>{r.value={username:"",email:"",password:"",is_active:!0}},V=()=>{c.value=!1,z.value=null,R(),m.value=!0},E=a=>{c.value=!0,z.value=a.id,r.value.username=a.username||"",r.value.email=a.email||"",r.value.password="",r.value.is_active=!!a.is_active,m.value=!0},L=async()=>{var a;await((a=P.value)==null?void 0:a.validate()),f.value=!0;try{if(c.value&&z.value){const l=await k.updateAdmin(z.value,{username:r.value.username,email:r.value.email,is_active:r.value.is_active});l.code===200?(n.success("更新成功"),m.value=!1,await w()):n.error(l.message||"更新失败");return}const e=await k.createAdmin({username:r.value.username,email:r.value.email,password:r.value.password,is_active:r.value.is_active});e.code===200?(n.success("创建成功"),m.value=!1,await w()):n.error(e.message||"创建失败")}catch{n.error("操作失败")}finally{f.value=!1}},$=async a=>{try{const e=await k.deleteAdmin(a.id);e.code===200?(n.success("删除成功"),U.value.length===1&&p.value>1&&(p.value-=1),await w()):n.error(e.message||"删除失败")}catch{n.error("删除失败")}},H=async a=>{p.value=a,await w()},K=async a=>{C.value=a,p.value=1,await w()},O=a=>{A.value=a,o.value.new_password="",o.value.confirm_password="",y.value=!0},Q=async()=>{var a;if(await((a=S.value)==null?void 0:a.validate()),o.value.new_password!==o.value.confirm_password){n.error("两次输入的密码不一致");return}f.value=!0;try{const e=A.value;if(!e)return;const l=await k.setAdminPassword(e.id,o.value.new_password);l.code===200?(n.success("密码已更新"),y.value=!1):n.error(l.message||"更新失败")}catch{n.error("更新失败")}finally{f.value=!1}};return Y(w),(a,e)=>(I(),Z("div",null,[t(s(_),{align:"center",justify:"space-between",style:{"margin-bottom":"24px"}},{default:u(()=>[e[13]||(e[13]=B("h2",{style:{margin:"0"}},"管理员设置",-1)),t(s(v),{type:"primary",onClick:V},{default:u(()=>[...e[12]||(e[12]=[b("新增管理员",-1)])]),_:1})]),_:1}),t(s(ee),null,{default:u(()=>[t(s(ae),{columns:j,data:U.value,loading:N.value,bordered:!1},null,8,["data","loading"]),B("div",ne,[t(s(le),{page:p.value,"onUpdate:page":[e[0]||(e[0]=l=>p.value=l),H],"page-size":C.value,"onUpdate:pageSize":[e[1]||(e[1]=l=>C.value=l),K],"item-count":x.value,"page-sizes":[20,50,100],"show-size-picker":""},null,8,["page","page-size","item-count"])])]),_:1}),t(s(q),{show:m.value,"onUpdate:show":e[7]||(e[7]=l=>m.value=l),preset:"card",style:{width:"520px"},title:c.value?"编辑管理员":"新增管理员"},{footer:u(()=>[t(s(_),{justify:"end"},{default:u(()=>[t(s(v),{onClick:e[6]||(e[6]=l=>m.value=!1)},{default:u(()=>[...e[14]||(e[14]=[b("取消",-1)])]),_:1}),t(s(v),{type:"primary",loading:f.value,onClick:L},{default:u(()=>[b(ue(c.value?"保存":"创建"),1)]),_:1},8,["loading"])]),_:1})]),default:u(()=>[t(s(D),{ref_key:"formRef",ref:P,model:r.value,"label-placement":"left","label-width":"90"},{default:u(()=>[t(s(g),{label:"用户名",path:"username",rule:{required:!0,message:"请输入用户名",trigger:["blur","input"]}},{default:u(()=>[t(s(h),{value:r.value.username,"onUpdate:value":e[2]||(e[2]=l=>r.value.username=l),placeholder:"请输入用户名"},null,8,["value"])]),_:1}),t(s(g),{label:"邮箱",path:"email",rule:{required:!0,message:"请输入邮箱",trigger:["blur","input"]}},{default:u(()=>[t(s(h),{value:r.value.email,"onUpdate:value":e[3]||(e[3]=l=>r.value.email=l),placeholder:"请输入邮箱"},null,8,["value"])]),_:1}),c.value?te("",!0):(I(),se(s(g),{key:0,label:"初始密码",path:"password",rule:{required:!0,message:"请输入密码",trigger:["blur","input"]}},{default:u(()=>[t(s(h),{value:r.value.password,"onUpdate:value":e[4]||(e[4]=l=>r.value.password=l),type:"password","show-password-on":"click",placeholder:"至少 6 位"},null,8,["value"])]),_:1})),t(s(g),{label:"启用",path:"is_active"},{default:u(()=>[t(s(re),{value:r.value.is_active,"onUpdate:value":e[5]||(e[5]=l=>r.value.is_active=l)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),t(s(q),{show:y.value,"onUpdate:show":e[11]||(e[11]=l=>y.value=l),preset:"card",style:{width:"520px"},title:"修改管理员密码"},{footer:u(()=>[t(s(_),{justify:"end"},{default:u(()=>[t(s(v),{onClick:e[10]||(e[10]=l=>y.value=!1)},{default:u(()=>[...e[15]||(e[15]=[b("取消",-1)])]),_:1}),t(s(v),{type:"primary",loading:f.value,onClick:Q},{default:u(()=>[...e[16]||(e[16]=[b("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:u(()=>[t(s(D),{ref_key:"pwdFormRef",ref:S,model:o.value,"label-placement":"left","label-width":"90"},{default:u(()=>[t(s(g),{label:"新密码",path:"new_password",rule:{required:!0,message:"请输入新密码",trigger:["blur","input"]}},{default:u(()=>[t(s(h),{value:o.value.new_password,"onUpdate:value":e[8]||(e[8]=l=>o.value.new_password=l),type:"password","show-password-on":"click",placeholder:"至少 6 位"},null,8,["value"])]),_:1}),t(s(g),{label:"确认密码",path:"confirm_password",rule:{required:!0,message:"请再次输入新密码",trigger:["blur","input"]}},{default:u(()=>[t(s(h),{value:o.value.confirm_password,"onUpdate:value":e[9]||(e[9]=l=>o.value.confirm_password=l),type:"password","show-password-on":"click",placeholder:"再次输入"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])]))}});export{ve as default};
